{"version":3,"sources":["scripts/login.js"],"names":["$","url","search","dom","SERVER","request","_ref","data","type","token","window","sessionStorage","getItem","ajax","contentType","beforeSend","dataType","loginCheck","usernameDom","psdDom","username","trim","val","psd","siblings","html","smsCheck","phoneDom","codeDom","phone","code","a","test","b","clearErrmsg","setToken","setItem","setUserData","res","id","userRegist","c","role","filter","config","password","message","console","sendSMS","phone_number","ele","attr","timer","setInterval","time","removeAttr","stopsend","switchStep","source","target","on","location","href","substring","lastIndexOf","replace","rs","$1","$2","name","decodeURIComponent","String","obj","addClass","removeClass","log","fail","err","userlogin","verify_code","serial_number","phoneBind","config2","resetPsd","thisPX","this","offset","left","thisPY","top","boxWidth","outerWidth","boxHeight","outerHeight","X","Y","mouseX","event","pageX","mouseY","pageY","s","i","transform","css"],"mappings":"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","file":"login.js","sourcesContent":["$(function () {\r\n  const SERVER = '/user-service/api/v1'\r\n\r\n  var params = getQueryObject();\r\n  if (params.target === 'reg') {\r\n    $('.chooseRole').addClass('on').siblings('div').removeClass('on')\r\n  }\r\n\r\n  //查询url参数\r\n  function getQueryObject(url) {\r\n    url = url == null ? window.location.href : url\r\n    const search = url.substring(url.lastIndexOf('?') + 1)\r\n    const obj = {}\r\n    const reg = /([^?&=]+)=([^?&=]*)/g\r\n    search.replace(reg, (rs, $1, $2) => {\r\n      const name = decodeURIComponent($1)\r\n      let val = decodeURIComponent($2)\r\n      val = String(val)\r\n      obj[name] = val\r\n      return rs\r\n    })\r\n    return obj\r\n  }\r\n\r\n  /**\r\n   * ajax请求\r\n   * @param {String} url 请求地址\r\n   * @param {Object} data 参数\r\n   * @param {String} type 类型\r\n   */\r\n  function request({\r\n    url,\r\n    data,\r\n    type\r\n  }) {\r\n    var token = getToken()\r\n    return $.ajax({\r\n      url: url,\r\n      type: type,\r\n      data: JSON.stringify(data),\r\n      contentType: \"application/json;charset=utf-8\",\r\n      beforeSend: res => {\r\n        if (token) {\r\n          res.setRequestHeader(\"Authorization\", token);\r\n        }\r\n      },\r\n      dataType: 'json'\r\n    })\r\n  }\r\n\r\n  //登录前检查 若验证通过，返回username,psd\r\n  function loginCheck(usernameDom, psdDom) {\r\n    let username = $.trim($(usernameDom).val())\r\n    let psd = $(psdDom).val()\r\n    if (!username) {\r\n      $(usernameDom).siblings('.errmsg').html('用户名不能为空')\r\n    }\r\n    if (!psd) {\r\n      $(psdDom).siblings('.errmsg').html('密码不能为空')\r\n    }\r\n    if (!username || !psd) {\r\n      return false\r\n    } else {\r\n      return {\r\n        username,\r\n        psd\r\n      }\r\n    }\r\n  }\r\n  //注册前检查 若验证通过，返回username,psd\r\n  function regCheck() {\r\n    var username = $('#regUserName').val()\r\n    var psd = $('#regPsd').val()\r\n    var namecheck = /^[a-zA-Z0-9_-]{4,16}$/\r\n    var psdcheck = /^.*(?=.{6,})(?=.*\\d)(?=.*[A-Z])(?=.*[a-z]).*$/\r\n    var a = namecheck.test($.trim(username))\r\n    var b = psdcheck.test(psd)\r\n    var c = psd === $('#confirmPsd').val()\r\n    if (!a) {\r\n      $('#regnameErr').html('用户名需要由4-16位大小写字母，数字，下划线组合')\r\n    }\r\n    if (!b) {\r\n      $('#regpsdErr').html('请输入大于6位，且至少包含有一个大写字母，一个小写字母和一个数字')\r\n    }\r\n    if (!c) {\r\n      $('#regconfirmpsdErr').html('两次密码不一致')\r\n    }\r\n    if (a && b && c) {\r\n      return {\r\n        username,\r\n        psd\r\n      }\r\n    } else {\r\n      return false\r\n    }\r\n  }\r\n\r\n  //绑定手机检查 若验证通过，参数分别是手机号dom和验证码dom，返回phone,code\r\n  function smsCheck(phoneDom, codeDom) {\r\n    var phone = $(phoneDom).val()\r\n    var code = $(codeDom).val()\r\n    var a = /^1[34578]\\d{9}$/.test(phone)\r\n    var b = /^\\d{4}$/.test(code)\r\n    if (!a) {\r\n      $(phoneDom).siblings('.errmsg').html('手机号码格式不正确')\r\n    }\r\n    if (!b) {\r\n      $(codeDom).siblings('.errmsg').html('验证码格式不正确')\r\n    }\r\n    if (a && b) {\r\n      return {\r\n        phone,\r\n        code\r\n      }\r\n    } else {\r\n      return false\r\n    }\r\n\r\n  }\r\n\r\n  //清除错误信息\r\n  function clearErrmsg() {\r\n    $('.errmsg').html('')\r\n  }\r\n\r\n  //设置token\r\n  function setToken(token) {\r\n    window.sessionStorage.setItem('hwUserToken', token)\r\n  }\r\n  //获取token\r\n  function getToken() {\r\n    return window.sessionStorage.getItem('hwUserToken')\r\n  }\r\n\r\n  //设置用户基本信息userid,roletype\r\n  function setUserData(res) {\r\n    window.sessionStorage.setItem('hwUserId', res.id)\r\n    window.sessionStorage.setItem('hwuserRole', JSON.stringify(res.role))\r\n  }\r\n\r\n  //发送验证码等待时间\r\n  function stopsend(ele) {\r\n    $(ele).attr('disabled', \"true\")\r\n    var time = 60\r\n    var timer = setInterval(function () {\r\n      if (time-- == 1) {\r\n        $(ele).removeAttr(\"disabled\")\r\n        clearInterval(timer)\r\n      }\r\n      $(ele).html(time == 0 ? '获取验证码' : time + 's')\r\n    }, 1000)\r\n  }\r\n\r\n  //登录\r\n  function userlogin() {\r\n    clearErrmsg()\r\n    let config = loginCheck('#loginUserName', '#loginPsd')\r\n    if (config) {\r\n      request({\r\n        url: `${SERVER}/users/login/`,\r\n        data: {\r\n          username: config.username,\r\n          password: config.psd,\r\n          type: 2\r\n        },\r\n        type: 'POST'\r\n      }).done(res => {\r\n        console.log(res)\r\n        $('#loginErr').html(res.message)\r\n        if (res.code === 0) {\r\n          setToken(res.data.token)\r\n          setUserData(res.data)\r\n        }\r\n      }).fail(function (err) {\r\n        console.log(err)\r\n      })\r\n    }\r\n  }\r\n  //注册\r\n  function userRegist() {\r\n    clearErrmsg()\r\n    var config = regCheck()\r\n    var role = $(\"[name='userrole']\").filter(\":checked\").val()\r\n    if (config) {\r\n      request({\r\n        url: `${SERVER}/users/register/`,\r\n        data: {\r\n          username: config.username,\r\n          password: config.psd,\r\n          role: parseInt(role)\r\n        },\r\n        type: 'POST'\r\n      }).done(res => {\r\n        $('#regErr').html(res.message)\r\n        console.log(res)\r\n        if (res.code === 0) {\r\n          setToken(res.data.token)\r\n          setUserData(res.data)\r\n          $('.bindPhone').addClass('on').siblings('div').removeClass('on')\r\n        }\r\n      })\r\n    }\r\n  }\r\n  //发送验证码\r\n  function sendSMS(phoneDom, type, dom) {\r\n    clearErrmsg()\r\n    var phone = $(phoneDom).val()\r\n    var a = /^1[34578]\\d{9}$/.test(phone)\r\n    if (!a) {\r\n      $(phoneDom).siblings('.errmsg').html('手机号码格式不正确')\r\n      return\r\n    } else {\r\n      request({\r\n        url: `${SERVER}/users/sms/`,\r\n        data: {\r\n          phone_number: phone,\r\n          type\r\n        },\r\n        type: 'POST',\r\n      }).done(res => {\r\n        stopsend(dom)\r\n        dom.data('serialNumber', res.data.serial_number)\r\n      })\r\n    }\r\n  }\r\n  //手机绑定\r\n  function phoneBind() {\r\n    clearErrmsg()\r\n    var number = $('#sendBindMsg').data('serialNumber')\r\n    var config = smsCheck('#bindphoneNum', '#verifyCode')\r\n    if (config) {\r\n      request({\r\n        url: `${SERVER}/users/phone/binding/`,\r\n        data: {\r\n          phone_number: config.phone,\r\n          verify_code: config.code,\r\n          serial_number: number,\r\n          type: 6\r\n        },\r\n        type: 'POST',\r\n      }).done(res => {\r\n        console.log(res)\r\n        $('#bindmsg').html(res.message)\r\n      })\r\n    }\r\n  }\r\n  //密码重置\r\n  function resetPsd() {\r\n    clearErrmsg()\r\n    var number = $('#sendResetPsdMsg').data('serialNumber')\r\n    var config = smsCheck('#resetPsdPhone', '#resetPsdverifyCode')\r\n    var config2 = loginCheck('#resetPsdName', '#resetPsdCode')\r\n    if (config && config2) {\r\n      request({\r\n        url: `${SERVER}/users/password/`,\r\n        data: {\r\n          username: config2.username,\r\n          password: config2.psd,\r\n          verify_code: config.code,\r\n          serial_number: number,\r\n          sms_type: 4,\r\n        },\r\n        type: 'put'\r\n      }).done(res => {\r\n        console.log(1, res)\r\n      })\r\n    }\r\n  }\r\n  //登录注册，步骤切换\r\n  function switchStep(source, target) {\r\n    $(source).on('click', function () {\r\n      $(target).addClass('on').siblings('div').removeClass('on')\r\n    })\r\n  }\r\n\r\n  switchStep('#toRegister', '.chooseRole')\r\n  switchStep('#tologin', '.loginForm')\r\n  switchStep('.chooseRole label', '.userRegister')\r\n  switchStep('#forgetpsd a', '.resetpsd')\r\n\r\n\r\n  $('#loginbtn').on('click', function () {\r\n    userlogin()\r\n  })\r\n  $('#nextstep').on('click', function () {\r\n    userRegist()\r\n  })\r\n  $('#sendBindMsg').on('click', function () {\r\n    sendSMS('#bindphoneNum', 6, $(this))\r\n  })\r\n  $('#sendResetPsdMsg').on('click', function () {\r\n    sendSMS('#resetPsdPhone', 4, $(this))\r\n  })\r\n  $('#complete').on('click', function () {\r\n    phoneBind()\r\n  })\r\n  $('#resetPsd').on('click', function () {\r\n    resetPsd()\r\n  })\r\n\r\n  //图片微交互\r\n  function shakeAnimation(dom){\r\n    $(dom).mouseenter(function() {\r\n      var thisPX = $(this).offset().left;\r\n      var thisPY = $(this).offset().top;\r\n      var boxWidth = $(this).outerWidth();\r\n      var boxHeight = $(this).outerHeight();\r\n      $(this).mousemove(function(event) {\r\n        var mouseX = event.pageX - thisPX;\r\n        var mouseY = event.pageY - thisPY;\r\n        var X;\r\n        var Y;\r\n        if (mouseX > boxWidth / 2) {\r\n          X = mouseX - boxWidth/2;\r\n        } else {\r\n          X = mouseX - boxWidth/2;\r\n        }\r\n        if (mouseY > boxHeight / 2) {\r\n          Y = boxHeight/2 - mouseY;\r\n        } else {\r\n          Y = boxHeight/2 - mouseY;\r\n        }\r\n  \r\n        $(this).find('img').each((i,v)=>{\r\n          var s = i%2 ===0?(10+10*i):(10+10*i)\r\n          $(v).css({\r\n            \"transform\": \"translateY(\"+X/s+\"px) \" +\"translateX(\"+Y/s+\"px) \"\r\n          })\r\n        })\r\n  \r\n        // $(this).css({\r\n        //   \"transform\": \"translateY(\"+X/20+\"px) \" +\"translateX(\"+Y/20+\"px) \"\r\n        // });\r\n        \r\n      });\r\n    });\r\n    $(dom).mouseleave(function() {\r\n      $(this).css({\r\n        \"transform\": \"rotateY(0deg) rotateX(0deg)\"\r\n      });\r\n    });  \r\n  }\r\n  shakeAnimation('.imgbox')\r\n\r\n})"]}